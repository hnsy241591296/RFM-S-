import streamlit as st
import pandas as pd
import google.generativeai as genai

# 1. é¡µé¢åŸºæœ¬è®¾ç½®ä¸æ ‡é¢˜
st.set_page_config(page_title="ç¤¾äº¤ç”µå•†æ™ºèƒ½è¥é”€ç³»ç»Ÿ", page_icon="ğŸ›’", layout="wide")
st.title("ğŸ›’ RFM-S ç¤¾äº¤ç”µå•†æ™ºèƒ½è¥é”€ç³»ç»Ÿ")
st.write("åŸºäº RFM-S èšç±»æ¨¡å‹ä¸ Gemini å¤§æ¨¡å‹çš„è‡ªåŠ¨åŒ–è¥é”€é—­ç¯")

# 2. è¯»å–æ•°æ® (ä½¿ç”¨ç¼“å­˜æœºåˆ¶ï¼Œæå‡ç½‘é¡µåŠ è½½é€Ÿåº¦)
@st.cache_data
def load_data():
    # è¯»å–ä½ ä¸Šä¼ çš„è„±æ•æ•°æ®
    return pd.read_csv("data/processed_rfms_data_full.csv")

try:
    df = load_data()
    st.write("### ğŸ“Š æ•°æ®é›†é¢„è§ˆ")
    st.dataframe(df.head())
except Exception as e:
    st.error(f"è¯»å–æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®ã€‚é”™è¯¯ä¿¡æ¯ï¼š{e}")
    st.stop() # åœæ­¢è¿è¡Œåç»­ä»£ç 

st.write("---")
st.write("### ğŸ¤– AI æ™ºèƒ½è¥é”€åŠ©æ‰‹")

# 3. äº¤äº’æ§åˆ¶å°
# å¯†ç æ¡†è®¾è®¡ï¼Œä¿æŠ¤ä½ çš„ API Key ä¸ä¼šè¢«å½•å±æˆ–å·çª¥æ³„éœ²
api_key = st.text_input("ğŸ”‘ è¯·è¾“å…¥æ‚¨çš„ Gemini 2.5 Flash API Keyï¼š", type="password")

# åŠ¨æ€è·å–æ•°æ®è¡¨ä¸­çš„åˆ—åï¼Œæ–¹ä¾¿ä½ æ‰¾ä¸€ä¸ªçœŸå®çš„ ID æµ‹è¯•
columns_list = df.columns.tolist()
st.caption(f"æç¤ºï¼šä½ çš„æ•°æ®è¡¨åŒ…å«è¿™äº›åˆ—: {', '.join(columns_list)}")

target_user_id = st.text_input("ğŸ¯ è¯·è¾“å…¥éœ€è¦è¯Šæ–­çš„ç”¨æˆ· ID (è¯·ä»ä¸Šæ–¹è¡¨æ ¼ä¸­æŒ‘é€‰ä¸€ä¸ªçœŸå®çš„ID)ï¼š", "")

# 4. æ ¸å¿ƒä¸šåŠ¡é—­ç¯ï¼šæ•°æ®æŸ¥è¯¢ + AI ç”Ÿæˆ
if st.button("âœ¨ åŸºäº RFM-S ç”»åƒä¸€é”®ç”Ÿæˆè£‚å˜æ–‡æ¡ˆ"):
    if not api_key:
        st.warning("âš ï¸ å¼¹è¯ä¸è¶³ï¼šè¯·å…ˆåœ¨ä¸Šæ–¹è¾“å…¥ API Keyï¼")
    elif not target_user_id:
        st.warning("âš ï¸ ç›®æ ‡ä¸¢å¤±ï¼šè¯·è¾“å…¥ç”¨æˆ· IDï¼")
    else:
        with st.spinner("æ­£åœ¨æ•°æ®åº“ä¸­æ£€ç´¢è¯¥ç”¨æˆ·çš„ RFM-S ç”»åƒï¼Œå¹¶å‘¼å« Gemini..."):
            try:
                # ã€å…³é”®æ•°æ®è”åŠ¨ï¼šä»åºå¤§çš„ DataFrame ä¸­æå‡ºè¿™ä¸ªäººçš„æ•°æ®ã€‘
                # æˆ‘ä»¬å‡è®¾ä½ çš„ç¬¬ä¸€åˆ—å°±æ˜¯ ID åˆ— (ä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ df.columns[0])
                id_column_name = df.columns[0] 
                
                # ç­›é€‰å‡ºè¯¥ç”¨æˆ·çš„æ•°æ® (å°†ä¸¤è¾¹éƒ½è½¬ä¸ºå­—ç¬¦ä¸²ä»¥é˜²ç±»å‹ä¸åŒ¹é…)
                user_data = df[df[id_column_name].astype(str) == str(target_user_id)]
                
                if user_data.empty:
                    st.error(f"ğŸ¤·â€â™‚ï¸ æŸ¥æ— æ­¤äººï¼šåœ¨æ•°æ®è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ° ID ä¸º {target_user_id} çš„ç”¨æˆ·ã€‚")
                else:
                    # æå–è¯¥ç”¨æˆ·çš„å…¨éƒ¨ç‰¹å¾ï¼Œè½¬æ¢ä¸ºå­—å…¸ï¼Œå†æ‹¼æ¥æˆä¸€æ®µæ–‡æœ¬ç»™å¤§æ¨¡å‹çœ‹
                    user_dict = user_data.iloc[0].to_dict()
                    user_profile_str = "\n".join([f"- **{k}**: {v}" for k, v in user_dict.items()])
                    
                    # åœ¨å‰ç«¯å±•ç¤ºæå–åˆ°çš„æ•°æ®ï¼Œå‘é¢è¯•å®˜è¯æ˜ä½ çš„æ•°æ®é“¾è·¯æ˜¯é€šçš„
                    with st.expander("âœ… æˆåŠŸæå–åˆ°ä»¥ä¸‹ç”¨æˆ·ç‰¹å¾ (ç‚¹å‡»å±•å¼€æŸ¥çœ‹)"):
                        st.markdown(user_profile_str)
                    
                    # --- æ¥å…¥ Gemini 2.5 Flash ---
                    genai.configure(api_key=api_key)
                    model = genai.GenerativeModel('gemini-2.5-flash')
                    
                    # æ„å»ºä¸“ä¸šçš„ Prompt (æç¤ºè¯å·¥ç¨‹)
                    prompt = f"""
                    ä½ ç°åœ¨æ˜¯ä¸€ä½ç²¾é€šâ€œç¤¾äº¤ç”µå•†ç”¨æˆ·è¡Œä¸ºåˆ†æâ€ä¸ç§åŸŸè¿è¥çš„èµ„æ·±ä¸“å®¶ã€‚
                    è¯·åŸºäºä»¥ä¸‹è¿™åç”¨æˆ·çš„çœŸå® RFM-Sï¼ˆæ¶ˆè´¹è¿‘æœŸã€é¢‘æ¬¡ã€é‡‘é¢ã€ç¤¾äº¤åˆ†äº«äº’åŠ¨ï¼‰ç‰¹å¾æ•°æ®ï¼Œ
                    ä¸ºTaé‡èº«å®šåˆ¶ 3 æ¡ä¸åŒé£æ ¼çš„å¾®ä¿¡ç¾¤/æœ‹å‹åœˆè£‚å˜è¥é”€æ–‡æ¡ˆã€‚
                    
                    ã€è¯¥ç”¨æˆ·çš„çœŸå®ç‰¹å¾æ•°æ®ã€‘ï¼š
                    {user_profile_str}
                    
                    ã€ä¸¥æ ¼è¦æ±‚ã€‘ï¼š
                    1. æ·±åº¦åˆ†æè¯¥ç”¨æˆ·çš„åˆ†å±‚æ ‡ç­¾å’Œ Sï¼ˆSocialï¼‰ç»´åº¦å€¼ã€‚å¦‚æœTaæ˜¯é«˜ç¤¾äº¤æ½œåŠ›ï¼Œé‡ç‚¹æ¿€åŠ±è£‚å˜ï¼›å¦‚æœæ˜¯æ²‰ç¡ç”¨æˆ·ï¼Œé‡ç‚¹å”¤é†’ã€‚
                    2. 3æ¡æ–‡æ¡ˆçš„é£æ ¼åˆ†åˆ«ä¸ºï¼šçœŸè¯šå…³æ€€é£ã€é™æ—¶åˆ©ç›Šè¯±æƒ‘é£ã€ç¤¾äº¤èº«ä»½è®¤åŒé£ã€‚
                    3. è¯æœ¯è‡ªç„¶ï¼Œå¿…é¡»åŒ…å«å¼ºçƒˆçš„â€œåˆ†äº«ç»™å¥½å‹â€æˆ–â€œé‚€è¯·å…¥ç¾¤â€çš„åŠ¨ä½œå¼•å¯¼ã€‚
                    """
                    
                    # å‘é€è¯·æ±‚å¹¶è·å–å¤§æ¨¡å‹å›å¤
                    response = model.generate_content(prompt)
                    
                    # å®Œç¾å±•ç¤ºç»“æœ
                    st.success("ğŸ‰ AI è£‚å˜ç­–ç•¥ç”Ÿæˆå®Œæ¯•ï¼")
                    st.markdown(response.text)
                    
            except Exception as e:
                st.error(f"âŒ è°ƒç”¨ API å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Key æ˜¯å¦æœ‰æ•ˆã€‚åº•å±‚æŠ¥é”™ï¼š{e}")